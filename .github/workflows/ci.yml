name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Lint shell scripts
        run: |
          docker run --rm -v "$PWD:/mnt" koalaman/shellcheck:stable \
            entrypoint.sh client-entrypoint.sh verify.sh

      - name: Check Dockerfile
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: Dockerfile

      - name: Check client Dockerfiles
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: clients/Dockerfile.client.24.04
          failure-threshold: warning

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build server
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: false
          tags: landscape-server:test
          cache-from: type=gha,scope=server
          cache-to: type=gha,mode=max,scope=server

  test-server:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Start server
        run: |
          docker compose up -d landscape
          echo "Waiting for server initialization..."
          sleep 120
        env:
          SKIP_HASH_ID_GENERATION: "true"

      - name: Check server health
        run: |
          # Check Apache is running
          docker exec landscape-server pgrep apache2 || exit 1

          # Check HTTPS responds
          curl -k -f https://localhost:443 || exit 1

          # Check login page loads
          curl -k https://localhost:443 | grep -q "Landscape" || exit 1

          # Check certificate is valid
          docker exec landscape-server openssl x509 -in /etc/ssl/certs/landscape_server.pem -noout -checkend 0 || exit 1

      - name: Check database
        run: |
          docker exec landscape-server su postgres -c "psql -l" | grep -q landscape-standalone-main || exit 1

      - name: Check services
        run: |
          # Check appserver process is running
          docker exec landscape-server pgrep -f landscape-appserver || exit 1

      - name: Export logs
        if: failure()
        run: |
          docker logs landscape-server > server-logs.txt
          docker exec landscape-server cat /var/log/landscape/appserver.log > appserver-logs.txt || true

      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v7
        with:
          name: server-logs
          path: "*-logs.txt"

      - name: Cleanup
        if: always()
        run: docker compose down -v

  test-client:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Start server and client
        run: |
          docker compose --profile with-client up -d
          echo "Waiting for initialization..."
          sleep 120
        env:
          SKIP_HASH_ID_GENERATION: "true"

      - name: Check client registration
        run: |
          # Verify containers are running
          docker ps | grep landscape || exit 1

          # Wait for client to register (may take additional time)
          echo "Waiting for client registration..."
          for i in {1..30}; do
            if docker exec landscape-client landscape-config --is-registered | grep -q "True"; then
              echo "Client registered successfully"
              break
            fi
            sleep 2
          done

          # Verify registration
          docker exec landscape-client landscape-config --is-registered | grep -q "True" || exit 1

          # Check client appears in database
          docker exec landscape-server su postgres -c \
            "psql landscape-standalone-main -c 'SELECT COUNT(*) FROM pending_computer;'" | grep -q "1" || exit 1

      - name: Export logs
        if: failure()
        run: |
          docker logs landscape-server > server-logs.txt
          docker logs landscape-client > client-logs.txt

      - name: Upload logs
        if: failure()
        uses: actions/upload-artifact@v7
        with:
          name: client-logs
          path: "*-logs.txt"

      - name: Cleanup
        if: always()
        run: docker compose --profile with-client down -v

  security-scan:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'trivy-results.sarif'
