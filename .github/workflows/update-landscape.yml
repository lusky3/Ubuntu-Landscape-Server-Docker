name: Update Landscape

on:
  schedule:
    - cron: '0 6 * * 1'  # Weekly on Monday
  workflow_dispatch:

jobs:
  check-landscape:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Landscape version
        id: check
        run: |
          docker run --rm ubuntu:24.04 bash -c "
            apt-get update -qq
            apt-cache policy landscape-server | grep Candidate | awk '{print \$2}'
          " > /tmp/latest_version
          LATEST=$(cat /tmp/latest_version)
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest Landscape version: $LATEST"
      
      - name: Update README
        run: |
          VERSION="${{ steps.check.outputs.latest }}"
          DATE=$(date +%Y-%m-%d)
          if ! grep -q "Landscape.*$VERSION" README.md; then
            sed -i "s/Landscape Server [0-9.]*/Landscape Server $VERSION/" README.md || true
            echo "Updated README with version $VERSION"
            echo "update_made=true" >> $GITHUB_ENV
          fi
      
      - name: Create Pull Request
        if: env.update_made == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update Landscape version to ${{ steps.check.outputs.latest }}"
          title: "Update Landscape to ${{ steps.check.outputs.latest }}"
          body: |
            Automated Landscape version update.
            
            Latest available: `${{ steps.check.outputs.latest }}`
            
            Please test before merging.
          branch: update-landscape-version
          delete-branch: true
