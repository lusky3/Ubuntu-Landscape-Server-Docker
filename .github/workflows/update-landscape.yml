name: Update Landscape

on:
  schedule:
    - cron: '0 6 * * 1'  # Weekly on Monday
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-landscape:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.check.outputs.latest }}
      update_available: ${{ steps.check.outputs.update_available }}
    steps:
      - uses: actions/checkout@v6

      - name: Check Landscape version
        id: check
        run: |
          LATEST=$(docker run --rm ubuntu:24.04 bash -c "
            apt-get update -qq 2>/dev/null
            apt-get install -y software-properties-common 2>/dev/null
            apt-add-repository -y ppa:landscape/self-hosted-24.04 2>/dev/null
            apt-get update -qq 2>/dev/null
            apt-cache policy landscape-server-quickstart | grep Candidate | awk '{print \$2}'
          ")
          echo "latest=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest Landscape version: $LATEST"

          # Check if version file exists and compare
          if [ -f .landscape-version ]; then
            CURRENT=$(cat .landscape-version)
            if [ "$CURRENT" != "$LATEST" ]; then
              echo "update_available=true" >> $GITHUB_OUTPUT
              echo "Update available: $CURRENT -> $LATEST"
            fi
          else
            echo "update_available=true" >> $GITHUB_OUTPUT
          fi

      - name: Update version file
        if: steps.check.outputs.update_available == 'true'
        run: |
          echo "${{ steps.check.outputs.latest }}" > .landscape-version
          echo "Updated to version ${{ steps.check.outputs.latest }}"

      - name: Create Pull Request
        if: steps.check.outputs.update_available == 'true'
        id: pr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update Landscape to ${{ steps.check.outputs.latest }}"
          title: "Update Landscape to ${{ steps.check.outputs.latest }}"
          body: |
            ðŸ”„ Automated Landscape version update detected.

            **New version**: `${{ steps.check.outputs.latest }}`

            CI will run comprehensive tests. If all pass, this will auto-merge.
          branch: update-landscape-${{ steps.check.outputs.latest }}
          delete-branch: true
          labels: |
            dependencies
            landscape
            auto-merge

      - name: Enable auto-merge
        if: steps.check.outputs.update_available == 'true' && steps.pr.outputs.pull-request-number
        run: gh pr merge --auto --squash "${{ steps.pr.outputs.pull-request-number }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
